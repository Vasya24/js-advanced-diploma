!function(e){var t={};function s(a){if(t[a])return t[a].exports;var i=t[a]={i:a,l:!1,exports:{}};return e[a].call(i.exports,i,i.exports,s),i.l=!0,i.exports}s.m=e,s.c=t,s.d=function(e,t,a){s.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:a})},s.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},s.t=function(e,t){if(1&t&&(e=s(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var a=Object.create(null);if(s.r(a),Object.defineProperty(a,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var i in e)s.d(a,i,function(t){return e[t]}.bind(null,i));return a},s.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return s.d(t,"a",t),t},s.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},s.p="",s(s.s=1)}([function(e,t,s){},function(e,t,s){"use strict";s.r(t);s(0);function a(e,t){switch(!0){case 0===e:return"top-left";case e===t-1:return"top-right";case e>0&&e<t-1:return"top";case e===t*(t-1):return"bottom-left";case e===t*t-1:return"bottom-right";case e>t*(t-1)&&e<t*t-1:return"bottom";case(e-(t-1))%t==0:return"right";case e>0&&e%t==0&&e<t*(t-1):return"left";default:return"center"}}class i{constructor(){this.boardSize=8,this.container=null,this.boardEl=null,this.cells=[],this.cellClickListeners=[],this.cellEnterListeners=[],this.cellLeaveListeners=[],this.newGameListeners=[],this.saveGameListeners=[],this.loadGameListeners=[]}bindToDOM(e){if(!(e instanceof HTMLElement))throw new Error("container is not HTMLElement");this.container=e}drawUi(e){this.checkBinding(),this.container.innerHTML='\n      <div class="controls">\n        <button data-id="action-restart" class="btn">New Game</button>\n        <button data-id="action-save" class="btn">Save Game</button>\n        <button data-id="action-load" class="btn">Load Game</button>\n      </div>\n      <div class="board-container">\n        <div data-id="board" class="board"></div>\n      </div>\n    ',this.newGameEl=this.container.querySelector("[data-id=action-restart]"),this.saveGameEl=this.container.querySelector("[data-id=action-save]"),this.loadGameEl=this.container.querySelector("[data-id=action-load]"),this.newGameEl.addEventListener("click",e=>this.onNewGameClick(e)),this.saveGameEl.addEventListener("click",e=>this.onSaveGameClick(e)),this.loadGameEl.addEventListener("click",e=>this.onLoadGameClick(e)),this.boardEl=this.container.querySelector("[data-id=board]"),this.boardEl.classList.add(e);for(let e=0;e<this.boardSize**2;e+=1){const t=document.createElement("div");t.classList.add("cell","map-tile","map-tile-"+a(e,this.boardSize)),t.addEventListener("mouseenter",e=>this.onCellEnter(e)),t.addEventListener("mouseleave",e=>this.onCellLeave(e)),t.addEventListener("click",e=>this.onCellClick(e)),this.boardEl.appendChild(t)}this.cells=Array.from(this.boardEl.children)}redrawPositions(e){for(const e of this.cells)e.innerHTML="";for(const s of e){const e=this.boardEl.children[s.position],a=document.createElement("div");a.classList.add("character",s.character.type);const i=document.createElement("div");i.classList.add("health-level");const l=document.createElement("div");l.classList.add("health-level-indicator","health-level-indicator-"+((t=s.character.health)<15?"critical":t<50?"normal":"high")),l.style.width=s.character.health+"%",i.appendChild(l),a.appendChild(i),e.appendChild(a)}var t}addCellEnterListener(e){this.cellEnterListeners.push(e)}addCellLeaveListener(e){this.cellLeaveListeners.push(e)}addCellClickListener(e){this.cellClickListeners.push(e)}addNewGameListener(e){this.newGameListeners.push(e)}addSaveGameListener(e){this.saveGameListeners.push(e)}addLoadGameListener(e){this.loadGameListeners.push(e)}onCellEnter(e){e.preventDefault();const t=this.cells.indexOf(e.currentTarget);this.cellEnterListeners.forEach(e=>e.call(null,t))}onCellLeave(e){e.preventDefault();const t=this.cells.indexOf(e.currentTarget);this.cellLeaveListeners.forEach(e=>e.call(null,t))}onCellClick(e){const t=this.cells.indexOf(e.currentTarget);this.cellClickListeners.forEach(e=>e.call(null,t))}onNewGameClick(e){e.preventDefault(),this.newGameListeners.forEach(e=>e.call(null))}onSaveGameClick(e){e.preventDefault(),this.saveGameListeners.forEach(e=>e.call(null))}onLoadGameClick(e){e.preventDefault(),this.loadGameListeners.forEach(e=>e.call(null))}static showError(e){alert(e)}static showMessage(e){alert(e)}selectCell(e,t="yellow"){this.deselectCell(e),this.cells[e].classList.add("selected","selected-"+t)}deselectCell(e){const t=this.cells[e];t.classList.remove(...Array.from(t.classList).filter(e=>e.startsWith("selected")))}showCellTooltip(e,t){this.cells[t].title=e}hideCellTooltip(e){this.cells[e].title=""}showDamage(e,t){return new Promise(s=>{const a=this.cells[e],i=document.createElement("span");i.textContent=t,i.classList.add("damage"),a.appendChild(i),i.addEventListener("animationend",()=>{a.removeChild(i),s()})})}setCursor(e){this.boardEl.style.cursor=e}checkBinding(){if(null===this.container)throw new Error("GamePlay not bind to DOM")}}function l(e){const t=[],s=[];for(let e=0;e<64;e+=1)0===e||e%8==0||e-1==0||(e-1)%8==0?t.push(e):e-7!=0&&(e-7)%8!=0&&e-6!=0&&(e-6)%8!=0||s.push(e);return["bowman","swordsman","magician"].includes(e.type)?t[Math.floor(Math.random()*(t.length-1))]:!!["undead","daemon","vampire"].includes(e.type)&&s[Math.floor(Math.random()*(s.length-1))]}class r{constructor(e,t="generic"){if(this.level=e,this.health=50,this.type=t,new.target===r)throw Error("You cannot create new object of Character. Please, use inherited classes")}}class n{constructor(e,t){if(!(e instanceof r))throw new Error("character must be instance of Character or its children");if("number"!=typeof t)throw new Error("position must be a number");this.character=e,this.position=t}}function*c(e,t){for(;;){const s=Math.floor(Math.random()*t)+1,a=e[Math.floor(Math.random()*e.length)];yield new a(s)}}function h(e,t,s){const a=[],i=[];for(let r=0;r<s;r+=1){const s=c(e,t).next().value;let r=l(s);for(;i.includes(r);)r=l(s);i.push(r),a.push(new n(s,r))}return a}function o(e,t,s,a){const i=[];let l=[];for(let e=0;e<64;e+=1)l.push(e),8===l.length&&(i.push(l),l=[]);const r=Math.floor(t/8),n=t%8,c=[];if("move"===e)for(let e=1;e<=s.walkAbility;e+=1){let t=r+e;t<8&&c.push(i[t][n]);let s=n+e;s<8&&c.push(i[r][s]),t<8&&s<8&&c.push(i[t][s]),t=r-e,t>=0&&c.push(i[t][n]),t>=0&&s<8&&c.push(i[t][s]),s=n-e,s>=0&&c.push(i[r][s]),t>=0&&s>=0&&c.push(i[t][s]),t=r+e,t<8&&s>=0&&c.push(i[t][s])}else{let e=r-s.attackAbility;e<0&&(e=0);let t=r+s.attackAbility;t>=8&&(t=7);let a=n-s.attackAbility;a<0&&(a=0);let l=n+s.attackAbility;l>=8&&(l=7);for(let s=e;s<=t;s+=1)for(let e=a;e<=l;e+=1)c.push(i[s][e])}return c.includes(a)}class d extends r{constructor(e,t="bowman"){super(e,t),this.attack=25,this.defence=25,this.walkAbility=2,this.attackAbility=2}}class u extends r{constructor(e,t="swordsman"){super(e,t),this.attack=40,this.defence=10,this.walkAbility=4,this.attackAbility=1}}class m extends r{constructor(e,t="magician"){super(e,t),this.attack=10,this.defence=40,this.walkAbility=1,this.attackAbility=4}}class p extends r{constructor(e,t="undead"){super(e,t),this.attack=25,this.defence=25,this.walkAbility=4,this.attackAbility=1}}class f extends r{constructor(e,t="vampire"){super(e,t),this.attack=40,this.defence=10,this.walkAbility=2,this.attackAbility=2}}class C extends r{constructor(e,t="daemon"){super(e,t),this.attack=10,this.defence=40,this.walkAbility=1,this.attackAbility=4}}class y{constructor(){this.turn="user"}static from(e){return"object"==typeof e?e:null}}class v{constructor(e,t){this.gamePlay=e,this.stateService=t,this.userTeam=h([d,u],1,2),this.computerTeam=h([p,C,f],1,2),this.players=[...this.userTeam,...this.computerTeam],this.gameState=new y,this.selectedCell=null,this.selectedMouseCell=null,this.selectedChar=null,this.level=1,this.points=0,this.locked=!1}static levelUp(e){e.health<=0||(e.level+=1,e.attack=Math.ceil(Math.max(e.attack,e.attack*(1.8-e.health/100))),e.defence=Math.ceil(Math.max(e.defence,e.defence*(1.8-e.health/100))),e.health+=80,e.health>100&&(e.health=100))}init(){this.gamePlay.drawUi("prairie"),this.gamePlay.redrawPositions(this.players),this.gamePlay.addCellEnterListener(this.onCellEnter.bind(this)),this.gamePlay.addCellLeaveListener(this.onCellLeave.bind(this)),this.gamePlay.addCellClickListener(this.onCellClick.bind(this)),this.gamePlay.addNewGameListener(this.onNewGameClick.bind(this)),this.gamePlay.addSaveGameListener(this.onSaveGameClick.bind(this)),this.gamePlay.addLoadGameListener(this.onLoadGameClick.bind(this))}async attack(e,t,s){const a=Math.ceil(Math.max(e.attack-t.character.defence,.1*e.attack));if(await this.gamePlay.showDamage(s,a),t.character.health-=a,t.character.health<=0){if(["bowman","swordsman","magician"].includes(t.character.type)){const e=this.userTeam.indexOf(t);this.userTeam.splice(e,1)}else{const e=this.computerTeam.indexOf(t);this.computerTeam.splice(e,1)}this.players=[...this.userTeam,...this.computerTeam]}this.gamePlay.redrawPositions(this.players),this.selectedChar=null,0===this.computerTeam.length&&this.nextLevel(),0===this.userTeam.length&&(this.gameOver(),i.showMessage("Вы проиграли!"))}async computerGame(){if(0===this.computerTeam.length)return;const e=[];this.computerTeam.forEach(t=>{const s=[];for(let e=0;e<this.userTeam.length;e+=1){const a=o("attack",t.position,t.character,this.userTeam[e].position);s.push(a)}e.push(s)});const t=e.findIndex((function(e){return e.includes(!0)}));if(-1!==t){const s=this.computerTeam[t].character,a=e[t].indexOf(!0),i=this.userTeam[a],l=i.position;await this.attack(s,i,l)}else{const e=Math.floor(Math.random()*this.computerTeam.length);let t="false";for(;"false"===t;){const s=Math.floor(64*Math.random());if(!this.players.find(e=>e.position===s)){o("move",this.computerTeam[e].position,this.computerTeam[e].character,s)&&(this.computerTeam[e].position=s,this.gamePlay.redrawPositions(this.players),t="true")}}}this.gameState.turn="user"}async onCellClick(e){if(this.locked)return!1;const t=this.players.find(t=>t.position===e);if(t)if(["bowman","swordsman","magician"].includes(t.character.type))this.gamePlay.selectCell(e),null!=this.selectedCell&&this.gamePlay.deselectCell(this.selectedCell),this.selectedCell=e,this.selectedChar=t;else{if(null===this.selectedChar)return;if(o("attack",this.selectedChar.position,this.selectedChar.character,e)){const t=this.selectedChar.character,s=this.players.find(t=>t.position===e);await this.attack(t,s,e),this.selectedChar=null,this.gameState.turn="computer",await this.computerGame()}else i.showError("You cannot play this character")}else if(null!==this.selectedChar){o("move",this.selectedChar.position,this.selectedChar.character,e)&&(this.selectedChar.position=e,this.gamePlay.redrawPositions(this.players),null!=this.selectedCell&&this.gamePlay.deselectCell(this.selectedCell),this.selectedChar=null,this.gameState.turn="computer",await this.computerGame())}this.selectedCell=null}onCellEnter(e){if(this.locked)return!1;const t=()=>{null!=this.selectedMouseCell&&this.gamePlay.deselectCell(this.selectedMouseCell),this.selectedMouseCell=e},s=this.players.find(t=>t.position===e);if(s)if(this.gamePlay.showCellTooltip(function(e){const t="⚔",s="🛡",a="❤";return`${"🎖"} ${e.character.level} ${t} ${e.character.attack} ${s} ${e.character.defence} ${a} ${e.character.health}`}(s),e),["undead","vampire","daemon"].includes(s.character.type)){if(null!==this.selectedChar){o("attack",this.selectedChar.position,this.selectedChar.character,e)?(this.gamePlay.setCursor("crosshair"),this.gamePlay.selectCell(e,"red"),t()):(this.gamePlay.setCursor("not-allowed"),t())}}else this.gamePlay.setCursor("pointer"),t();else if(null!==this.selectedChar){o("move",this.selectedChar.position,this.selectedChar.character,e)?(this.gamePlay.setCursor("pointer"),this.gamePlay.selectCell(e,"green"),t()):(this.gamePlay.setCursor("not-allowed"),t())}}onCellLeave(e){this.gamePlay.hideCellTooltip(e)}onNewGameClick(){this.userTeam=h([d,u],1,2),this.computerTeam=h([p,C,f],1,2),this.players=[...this.userTeam,...this.computerTeam],this.gamePlay.drawUi("prairie"),this.gamePlay.redrawPositions(this.players),this.selectedCell=null,this.selectedMouseCell=null,this.selectedChar=null,this.level=1,this.points=0,this.locked=!1}onSaveGameClick(){const e={userTeam:this.userTeam,computerTeam:this.computerTeam,level:this.level,points:this.points,selectedCell:this.selectedCell,selectedChar:this.selectedChar,gameState:this.gameState};this.stateService.save(y.from(e)),i.showMessage("Game saved")}onLoadGameClick(){const e=this.stateService.load();e?(this.userTeam=e.userTeam,this.computerTeam=e.computerTeam,this.level=e.level,this.points=e.points,this.selectedCell=e.selectedCell,this.selectedChar=e.selectedChar,this.gameState=e.gameState,this.players=[...this.userTeam,...this.computerTeam],this.gamePlay.drawUi({1:"prairie",2:"desert",3:"arctic",4:"mountain"}[e.level]),this.gamePlay.redrawPositions(this.players)):i.showError("We cannot load this game")}gameOver(){this.locked=!0,this.gamePlay.setCursor("not-allowed"),this.points>this.gameState.points&&(this.gameState.points=this.points)}nextLevel(){this.level+=1,this.userTeam.forEach(e=>{this.points+=e.character.health});let e,t=[];const s=e=>{if(e.character.level>1){const{level:t}=e.character;for(let s=2;s<=t;s+=1)v.levelUp(e.character);e.character.level=t}},a=(a,i,r)=>{e=h([d,u,m],i,a),e.forEach(e=>{t.push(e.position),s(e)}),this.userTeam.forEach(e=>{for(v.levelUp(e.character),e.position=l(e.character);t.includes(e.position);)e.position=l(e.character)}),this.userTeam=this.userTeam.concat(e),this.computerTeam=h([p,C,f],r,this.userTeam.length),this.computerTeam.forEach(e=>s(e)),this.players=[...this.userTeam,...this.computerTeam]};switch(this.level){case 2:this.gamePlay.drawUi("desert"),a(1,1,2);break;case 3:this.gamePlay.drawUi("arctic"),a(2,2,3);break;case 4:this.gamePlay.drawUi("mountain"),a(2,3,4);break;default:this.gameOver(),i.showMessage("Ура! Победа!")}t=[]}}const g=new i;g.bindToDOM(document.querySelector("#game-container"));const w=new class{constructor(e){this.storage=e}save(e){this.storage.setItem("state",JSON.stringify(e))}load(){try{return JSON.parse(this.storage.getItem("state"))}catch(e){throw new Error("Invalid state")}}}(localStorage);new v(g,w).init()}]);